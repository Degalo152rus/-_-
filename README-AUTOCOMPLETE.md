# Инструкция по интеграции автокомплита с сервером

## Обзор
Форма калькулятора теперь использует автокомплит для полей "Откуда" и "Куда". Данные запрашиваются с сервера и туда же отправляются результаты.

## Файлы проекта

1. **form-calculator.html** - обновлённая HTML разметка формы
2. **autocomplete.css** - стили для автокомплита
3. **autocomplete.js** - JavaScript логика автокомплита и отправки формы

## Подключение файлов

Добавьте в `<head>` вашей страницы:
```html
<link rel="stylesheet" href="autocomplete.css">
```

Добавьте перед закрывающим тегом `</body>`:
```html
<script src="autocomplete.js"></script>
```

## API Endpoints, которые нужно реализовать на сервере

### 1. Поиск городов (GET)
**URL:** `/api/cities/search`

**Параметры запроса:**
- `q` (string) - поисковый запрос (минимум 2 символа)

**Пример запроса:**
```
GET /api/cities/search?q=Моск
```

**Формат ответа (JSON):**
```json
{
  "cities": [
    {
      "id": 1,
      "name": "Москва",
      "region": "Московская область"
    },
    {
      "id": 77,
      "name": "Мосальск",
      "region": "Калужская область"
    }
  ]
}
```

**Поля:**
- `id` (number) - уникальный ID города
- `name` (string) - название города
- `region` (string) - регион/область

---

### 2. Отправка формы калькулятора (POST)
**URL:** `/api/calculator/submit`

**Метод:** POST

**Content-Type:** application/json

**Формат отправляемых данных:**
```json
{
  "city_from_id": 1,
  "city_from": "Москва",
  "city_from_region": "Московская область",
  "city_to_id": 2,
  "city_to": "Санкт-Петербург",
  "city_to_region": "Ленинградская область",
  "volume": "10",
  "weight": "5",
  "timestamp": "2025-11-08T12:34:56.789Z"
}
```

**Поля:**
- `city_from_id` (number|null) - ID города отправления
- `city_from` (string) - название города отправления
- `city_from_region` (string|null) - регион отправления
- `city_to_id` (number|null) - ID города назначения
- `city_to` (string) - название города назначения
- `city_to_region` (string|null) - регион назначения
- `volume` (string) - объём груза в куб.м
- `weight` (string) - масса груза в тоннах
- `timestamp` (string) - время отправки формы в ISO 8601

**Формат ответа (JSON):**
```json
{
  "success": true,
  "data": {
    "calculation_id": "abc123",
    "estimated_cost": 25000,
    "delivery_days": 3,
    "discount": 10
  }
}
```

или в случае ошибки:
```json
{
  "success": false,
  "error": "Описание ошибки"
}
```

---

## Настройка API URL в коде

Откройте файл `autocomplete.js` и замените заглушки на реальные URL:

### Для автокомплита городов:
```javascript
// Найдите в коде (строки ~24 и ~27):
this.apiUrl = options.apiUrl || '/api/cities/search';

// Замените на:
this.apiUrl = options.apiUrl || 'https://ваш-сервер.ru/api/cities/search';
```

### Для отправки формы:
```javascript
// Найдите в коде (строки ~25 и ~28):
this.submitUrl = options.submitUrl || '/api/calculator/submit';

// Замените на:
this.submitUrl = options.submitUrl || 'https://ваш-сервер.ru/api/calculator/submit';
```

### Также в конструкторе CalculatorForm:
```javascript
// Найдите в коде (строка ~199):
this.submitUrl = '/api/calculator/submit';

// Замените на:
this.submitUrl = 'https://ваш-сервер.ru/api/calculator/submit';
```

---

## Функционал автокомплита

### Основные возможности:
- ✅ Поиск начинается после ввода 2+ символов
- ✅ Debounce 300ms для уменьшения нагрузки на сервер
- ✅ Навигация клавиатурой (стрелки вверх/вниз, Enter, Escape)
- ✅ Подсветка совпадений в результатах
- ✅ Индикатор загрузки
- ✅ Отображение ошибок
- ✅ Закрытие при клике вне элемента

### Валидация формы:
- Проверка обязательных полей (город отправления и назначения)
- Проверка наличия объёма или массы груза

---

## Тестирование

### Временные данные
Пока у вас нет сервера, код использует моковые данные для демонстрации работы автокомплита.

**Список городов в заглушке:**
- Москва
- Санкт-Петербург
- Новосибирск
- Екатеринбург
- Казань
- Нижний Новгород
- Челябинск
- Самара
- Омск
- Ростов-на-Дону

### Как протестировать:
1. Откройте страницу в браузере
2. Введите в поле "Откуда" или "Куда" минимум 2 символа
3. Должен появиться список городов
4. Выберите город кликом или клавишей Enter
5. Заполните остальные поля
6. Нажмите "Рассчитать"
7. Откройте консоль браузера (F12) - там будут видны отправляемые данные

---

## Переход на реальный API

Когда сервер будет готов:

1. Замените URL в `autocomplete.js` (см. раздел "Настройка API URL")
2. Удалите или закомментируйте метод `getMockCities()` (строки ~117-146)
3. Раскомментируйте реальный API запрос в методе `fetchSuggestions()` (строки ~97-110)
4. Раскомментируйте реальный API запрос в методе `submitForm()` (строки ~259-273)

---

## Дополнительные настройки

### Изменение задержки debounce:
```javascript
const autocompleteFrom = new CityAutocomplete('form_value-from', 'suggestions-from', {
    apiUrl: '/api/cities/search',
    debounceDelay: 500 // изменить на нужное значение в миллисекундах
});
```

### Добавление заголовков авторизации:
В методе `fetchSuggestions()` добавьте:
```javascript
const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`, {
    method: 'GET',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_TOKEN' // если требуется
    }
});
```

---

## Поддержка и расширение

### Как добавить дополнительные поля:
1. Добавьте HTML поле в `form-calculator.html`
2. Добавьте сбор данных в метод `collectFormData()` класса `CalculatorForm`
3. Обновите валидацию в методе `validateForm()` при необходимости

### Как кастомизировать отображение результатов:
Измените шаблон в методе `displaySuggestions()` (строки ~155-160)

---

## Контакты для вопросов
При возникновении проблем проверьте:
- Консоль браузера (F12) на наличие ошибок
- Вкладку Network для проверки API запросов
- Правильность URL endpoints

---

## Чеклист запуска

- [ ] Подключены файлы `autocomplete.css` и `autocomplete.js`
- [ ] Обновлена HTML разметка формы (`form-calculator.html`)
- [ ] Настроены URL для API endpoints
- [ ] Реализован серверный endpoint `/api/cities/search`
- [ ] Реализован серверный endpoint `/api/calculator/submit`
- [ ] Протестирована работа автокомплита
- [ ] Протестирована отправка формы
- [ ] Настроена обработка ошибок на сервере
